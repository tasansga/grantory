name: Release CLI

on:
  push:
    tags:
      - "cli-v*.*.*"

jobs:
  build-cli:
    name: Build CLI
    permissions:
      contents: read
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: ubuntu-24.04
            arch: amd64
          - runner: ubuntu-24.04-arm
            arch: arm64
    steps:
      - name: Check out the code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.25"
      - name: Tidy modules
        run: go mod tidy
      - name: Install sqlite3 build deps
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends libsqlite3-dev
      - name: Import GPG key
        uses: crazy-max/ghaction-import-gpg@v6
        with:
          gpg_private_key: ${{ secrets.GPG_PRIVATE_KEY }}
          passphrase: ${{ secrets.PASSPHRASE }}
      - name: Build and package artifacts
        run: |
          set -euo pipefail
          RAW_TAG=${GITHUB_REF#refs/tags/}
          TAG_VERSION=${RAW_TAG#cli-v}
          VERSION=$TAG_VERSION
          RELEASE_DIR=release/dist
          mkdir -p "$RELEASE_DIR"
          CGO_ENABLED=1 GOOS=linux GOARCH="${{ matrix.arch }}" go build -o "$RELEASE_DIR/grantory" ./cmd/grantory
          zip -j "$RELEASE_DIR/grantory_${VERSION}_linux_${{ matrix.arch }}.zip" "$RELEASE_DIR/grantory"
          rm "$RELEASE_DIR/grantory"
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: grantory-cli-${{ matrix.arch }}
          path: release/dist/*.zip

  release-cli:
    name: Release CLI
    needs: build-cli
    permissions:
      contents: write
    runs-on: ubuntu-24.04
    steps:
      - name: Check out the code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: release/dist
          merge-multiple: true
      - name: Import GPG key
        uses: crazy-max/ghaction-import-gpg@v6
        with:
          gpg_private_key: ${{ secrets.GPG_PRIVATE_KEY }}
          passphrase: ${{ secrets.PASSPHRASE }}
      - name: Create checksum files
        run: |
          set -euo pipefail
          RAW_TAG=${GITHUB_REF#refs/tags/}
          TAG_VERSION=${RAW_TAG#cli-v}
          VERSION=$TAG_VERSION
          cd release/dist
          sha256sum grantory_${VERSION}_linux_*.zip > grantory_${VERSION}_SHA256SUMS
          sha256sum grantory_${VERSION}_linux_*.zip > checksums_${VERSION}_SHA256SUMS
      - name: Sign checksum files
        run: |
          set -euo pipefail
          RAW_TAG=${GITHUB_REF#refs/tags/}
          TAG_VERSION=${RAW_TAG#cli-v}
          VERSION=$TAG_VERSION
          cd release/dist
          FILES=(grantory_${VERSION}_SHA256SUMS checksums_${VERSION}_SHA256SUMS)
          for file in "${FILES[@]}"; do
            gpg --batch --yes --detach-sign --output "${file}.sig" "${file}"
          done
      - name: Publish release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          draft: false
          files: release/dist/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
